# FILE: components/schemas.yaml

# ==========================================
# 1. USER & AUTH MODULE (EXISTING)
# ==========================================
User:
  type: object
  properties:
    id:
      type: integer
      format: int64
      example: 3
    name:
      type: string
      maxLength: 150 # Update Sesuai DB
      example: Farhan Rizki Maulana
    username:
      type: string
      maxLength: 100 # Update Sesuai DB
      example: farhanrizkimln
    role:
      type: string
      enum: [owner, kasir, staff, courier]
      example: owner
    phone: # <--- UPDATE BARU SESUAI DB
      type: string
      maxLength: 30
      nullable: true
      example: "081234567890"
    is_active:
      type: boolean
      example: true
      description: "If false, user is suspended/resigned (Soft Delete)."
    created_at:
      type: string
      format: date-time
      example: "2024-01-30T10:00:00Z"

LoginRequest:
  type: object
  required:
    - username
    - password
  properties:
    username:
      type: string
      example: farhanrizkimln
    password:
      type: string
      example: password123

LoginSuccess:
  type: object
  properties:
    data:
      $ref: "./schemas.yaml#/LoginData" # Self-reference
    message:
      type: string
      example: "Login successful"

LoginData:
  type: object
  properties:
    access_token:
      type: string
      example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
    token_type:
      type: string
      example: Bearer
    expires_in:
      type: integer
      example: 3600
    user:
      $ref: "./schemas.yaml#/User" # Self-reference

# ==========================================
# 2. COMMON RESPONSES (EXISTING)
# ==========================================

SuccessResponse:
  type: object
  properties:
    message:
      type: string
      example: "Operation successful"

ErrorResponse:
  type: object
  properties:
    error:
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: string
          example: validation_error
        message:
          type: string
          example: Validation failed
        details:
          type: array
          items:
            type: object
            properties:
              field:
                type: string
              message:
                type: string

# ==========================================
# 3. SERVICE MODULE (EXISTING)
# ==========================================

ServiceCategory:
  type: object
  properties:
    id:
      type: integer
      format: int64
      example: 1
    name:
      type: string
      maxLength: 150 # Sesuai DB VARCHAR(150)
      example: "Cuci Komplit"
    description:
      type: string
      maxLength: 255 # Sesuai DB VARCHAR(255)
      nullable: true
      example: "Layanan cuci bersih + setrika rapi + parfum"
    is_active:
      type: boolean # Sesuai DB TINYINT(1)
      example: true
    created_at:
      type: string
      format: date-time
      example: "2024-02-20T10:00:00Z"

Services:
  type: object
  properties:
    id:
      type: integer
      format: int64
      example: 10
    category_id: # Sesuai DB: BIGINT(19), Foreign Key
      type: integer
      format: int64
      nullable: true # Sesuai DB: Allow Null = Centang
      example: 1
      description: "ID of the Service Category"
    code: # Sesuai DB: VARCHAR(50), UNIQUE
      type: string
      maxLength: 50
      example: "CK-REG-01"
      description: "Unique code for service"
    name: # Sesuai DB: VARCHAR(150)
      type: string
      maxLength: 150
      example: "Cuci Komplit Reguler"
    unit: # Sesuai DB: VARCHAR(20)
      type: string
      maxLength: 20
      example: "kg"
      description: "Unit measurement (kg, pcs, m2)"
    unit_price: # Sesuai DB: BIGINT(19)
      type: integer
      format: int64
      example: 7000
      description: "Price per unit"
    is_active: # Sesuai DB: TINYINT(1)
      type: boolean
      example: true
    created_at: # Sesuai DB: TIMESTAMP
      type: string
      format: date-time

# ==========================================
# 4. ORDER MODULE (NEW - SESUAI DB REAL)
# ==========================================

# Request Body saat Kasir input Order Baru
CreateOrderRequest:
  type: object
  required:
    - customer_name
    - items
  properties:
    customer_name:
      type: string
      maxLength: 150
      example: "Budi Santoso"
    customer_phone:
      type: string
      maxLength: 30
      example: "08123456789"
    customer_address:
      type: string
      description: "Alamat wajib diisi jika delivery"
      example: "Jl. Mawar No. 10"
    is_delivery:
      type: boolean
      default: false
      example: true
    notes:
      type: string
      description: "Catatan khusus untuk order ini"
      example: "Harap hati-hati, baju mahal"
    estimated_ready_at:
      type: string
      format: date-time
      description: "Estimasi kapan laundry selesai"
      example: "2025-12-21T17:00:00Z"
    items:
      type: array
      minItems: 1
      items:
        type: object
        required: [service_id]
        properties:
          service_id:
            type: integer
            example: 1
          quantity:
            type: integer
            description: "Jumlah pcs/kantong (masuk ke kolom quantity)"
            example: 1
          weight_kg:
            type: number
            format: float
            description: "Berat kilogram (masuk ke kolom weight_kg). Jika satuan, isi 0 atau null."
            example: 5.0

# Entity Order (Header) - Sesuai Tabel `orders`
Order:
  type: object
  properties:
    id:
      type: integer
      format: int64
      example: 101
    kode_nota:
      type: string
      maxLength: 50
      example: "INV-20251219-001"
    customer_name:
      type: string
      maxLength: 150
      example: "Budi Santoso"
    customer_phone:
      type: string
      maxLength: 30
      example: "08123456789"
    customer_address:
      type: string
      nullable: true
      example: "Jl. Mawar No 10"
    is_delivery:
      type: boolean # Tinyint(1) di DB
      example: true
    total_price:
      type: integer
      format: int64
      description: "Total akumulasi dari subtotal items"
      example: 40000
    payment_status:
      type: string
      enum: ["unpaid", "paid", "cod_pending"]
      example: "paid"
    status_internal:
      type: string
      enum:
        [
          "pending",
          "in-progress",
          "ready-pickup",
          "ready-delivery",
          "finished-delivery",
          "picked-up",
          "cancelled",
        ]
      example: "finished-delivery"
    estimated_ready_at:
      type: string
      format: date-time
      nullable: true
      example: "2025-12-21T17:00:00Z"
    notes:
      type: string
      nullable: true
      example: "Harap hati-hati"
    created_by:
      type: integer
      format: int64
      description: "ID User (Kasir) yang menginput"
      example: 5
    created_at:
      type: string
      format: date-time
    updated_at:
      type: string
      format: date-time
    delivery:
      $ref: "../components/schemas.yaml#/DeliveryInfo"
    items:
      type: array
      items:
        $ref: "#/OrderItem"

# Entity OrderItem (Detail) - Sesuai Tabel `order_items`
OrderItem:
  type: object
  properties:
    id:
      type: integer
      format: int64
      example: 5001
    order_id:
      type: integer
      format: int64
      example: 101
    service_id:
      type: integer
      format: int64
      example: 1
    description:
      type: string
      maxLength: 255
      description: "Nama layanan saat transaksi terjadi (Snapshot)"
      example: "Cuci Kiloan Reguler"
    quantity:
      type: integer
      example: 1
    weight_kg:
      type: number
      format: double # Decimal 8,2
      example: 5.00
    unit_price:
      type: integer
      format: int64
      description: "Harga satuan per kg/pcs saat transaksi"
      example: 8000
    subtotal:
      type: integer
      format: int64
      description: "Hasil kali (Qty/Weight * Unit Price)"
      example: 40000

# Wrapper Response khusus Order (Message + Data)
OrderResponse:
  type: object
  properties:
    message:
      type: string
      example: "Order created successfully"
    data:
      $ref: "#/Order"

# ==========================================
# 5. LIST RESPONSE WRAPPER (Pagination)
# ==========================================

# Metadata untuk Pagination (Info Halaman)
PaginationMeta:
  type: object
  properties:
    current_page:
      type: integer
      example: 1
    total_pages:
      type: integer
      example: 5
    total_items:
      type: integer
      example: 50
    per_page:
      type: integer
      example: 10

# Wrapper untuk Response berupa LIST (Array)
OrderListResponse:
  type: object
  properties:
    message:
      type: string
      example: "Orders retrieved successfully"
    data:
      type: array
      items:
        # Kita REUSE (Pakai Ulang) Entity Order yang sudah lengkap tadi
        $ref: "#/Order"
    meta:
      $ref: "#/PaginationMeta"

# ==========================================
# 6. PAYMENT MODULE
# ==========================================

# Request Body (Input Kasir)
CreatePaymentRequest:
  type: object
  required:
    - amount
    - method
  properties:
    amount:
      type: integer
      description: "Nominal uang (Sesuai kolom amount)"
      example: 50000
    method:
      type: string
      description: "Metode bayar (Sesuai ENUM database)"
      enum: ["cash", "transfer", "qris", "ewallet"]
      example: "cash"
    status:
      type: string
      description: "Status pembayaran (Default: confirmed jika Cash)"
      enum: ["pending", "confirmed"]
      default: "confirmed"
    collected_at:
      type: string
      format: date-time
      description: "Waktu uang diterima (Boleh kosong, default: NOW)"
      example: "2023-12-20T14:00:00Z"

# Entity Payment (Database Snapshot)
Payment:
  type: object
  properties:
    id:
      type: integer
      example: 1
    order_id:
      type: integer
      example: 101
    method:
      type: string
      example: "cash"
    amount:
      type: integer
      example: 50000
    status:
      type: string
      example: "confirmed"
    collected_by:
      type: integer
      description: "ID User/Staff yang menerima uang"
      example: 5
    collected_at:
      type: string
      format: date-time
    created_at:
      type: string
      format: date-time
    deleted_at:
      type: string
      format: date-time
      nullable: true
      description: "Diisi jika pembayaran dibatalkan (Soft Delete)"

# Response Wrapper
PaymentResponse:
  type: object
  properties:
    message:
      type: string
      example: "Payment recorded successfully"
    data:
      $ref: "#/Payment"

# ==========================================
# 7. DELIVERY MODULE
# ==========================================

DeliveryInfo:
  type: object
  properties:
    id:
      type: integer
      example: 55
    courier_id:
      type: integer
      example: 5
    courier_name:
      type: string
      example: "Ujang Kurir"
    picked_at:
      type: string
      format: date-time
      description: "Waktu berangkat"

    # --- CUKUP TAMBAH INI SAJA ---
    delivered_at:
      type: string
      format: date-time
      nullable: true # <--- PENTING!
      description: "Waktu sampai (Null jika masih dijalan)"
      example: "2025-12-22T13:45:00Z"
    # -----------------------------

    cod_collected_amount:
      type: integer
      example: 0
